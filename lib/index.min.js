!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("mini-create-react-context"),require("prop-types"),require("react-router-dom")):"function"==typeof define&&define.amd?define(["exports","react","mini-create-react-context","prop-types","react-router-dom"],t):t(e.CacheRoute={},e.React,e.createContext,e.PropTypes,e.reactRouterDom)}(this,function(e,j,t,n,u){"use strict";var P="default"in j?j.default:j;t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n;var o=function(e){return void 0===e},l=function(e){return null===e},i=function(e){return"function"==typeof e},h=function(e){return"string"==typeof e},r=function(e){return!(o(e)||l(e))},c=function(e){return e instanceof Array},E=function(e){return"number"==typeof e&&!((t=e)!=t);var t},s=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2];try{E(t)&&(t=String(t));var r=(h(t)?t.split("."):t).reduce(function(e,t){return e[t]},e);return o(r)?n:r}catch(e){return n}},R=function(e){for(var t=arguments.length,n=Array(2<t?t-2:0),r=2;r<t;r++)n[r-2]=arguments[r];var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];o=h(o)?o.split("."):o;var c=s(e,o),a=s(e,o.slice(0,-1));return i(c)?c.call.apply(c,[a].concat(n)):c},y=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce(function(e,t){return o(e)?R(t):R(e)},void 0)},a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},f=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},d=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),p=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},S=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},m=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},T=function(e,t){var n={};for(var r in e)0<=t.indexOf(r)||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n},v=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},L=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,c=void 0;try{for(var a,i=e[Symbol.iterator]();!(r=(a=i.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,c=e}finally{try{!r&&i.return&&i.return()}finally{if(o)throw c}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},b=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}(),w="object"===("undefined"==typeof global?"undefined":a(global))&&global&&global.Math===Math&&global.Array===Array?global:b,g=function(e){var t=[];for(var n in e)t.push(e[n]);return t},C=s(w,"document.body"),O=s(w,"document.scrollingElement",s(w,"document.documentElement",{}));function M(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return!!r(e)&&(e.scrollWidth>e.clientWidth||e.scrollHeight>e.clientHeight)}function N(e){return i(s(w,"document.getElementById"))?[].concat(_(y(R(e,"querySelectorAll","*"),[])),[e]).filter(M):[]}function A(e){var t=[].concat(_(new Set([].concat(_(function n(e){return e.reduce(function(e,t){return[].concat(_(e),_(c(t)?n(t):[t]))},[])}((c(e)?e:[e]).map(N))),_([O,C].filter(M)))))).map(function(e){return[e,{x:e.scrollLeft,y:e.scrollTop}]});return function(){t.forEach(function(e){var t=L(e,2),n=t[0],r=t[1],o=r.x,c=r.y;n.scrollLeft=o,n.scrollTop=c})}}var k={},x=function(){return Object.entries(k).filter(function(e){var t=L(e,2)[1];return t instanceof Y?t.state.cached:Object.values(t).some(function(e){return e.state.cached})})},D=function(){return S({},k)},q=function(e,t){k[e]=t},K=function(e){delete k[e]},F=function(e){return R(e,"reset")},U=function(e){var t=s(k,[e]);t&&(t instanceof Y?F(t):Object.values(t).forEach(F))},B=function(e){return R(e,"refresh")},H=t(),W=H.Provider;H.Consumer;function V(t,n){if(i(j.useContext)){var r=j.useContext(H);j.useEffect(function(){var e=R(r,"on",t,n);return function(){return R(e)}},[])}}var I=V.bind(null,"didCache"),X=V.bind(null,"didRecover"),z=r(P.forwardRef),G="__isComputedUnmatch",J=function(e){return r(e)&&!0!==s(e,G)},Q=function(e,t){var n=e.match,r=e.when,o=void 0===r?"forward":r;if(J(n)||(n=null),!t.cached&&n)return{cached:!0,matched:!0};if(t.matched&&!n){var c=s(e,"history.action"),a=!1;if(i(o))a=!o(e);else switch(o){case"always":break;case"back":["PUSH","REPLACE"].includes(c)&&(a=!0);break;case"forward":default:"POP"===c&&(a=!0)}if(a)return{cached:!1,matched:!1}}return{matched:!!n}},Y=function(e){function l(e){var t;f(this,l);for(var n=arguments.length,r=Array(1<n?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];var c=v(this,(t=l.__proto__||Object.getPrototypeOf(l)).call.apply(t,[this,e].concat(r)));if(c.cacheLifecycles={__listener:{},__didCacheListener:{},__didRecoverListener:{},on:function(e,t){var n=Math.random(),r="__"+e+"Listener";return c.cacheLifecycles[r][n]=t,function(){delete c.cacheLifecycles[r][n]}},didCache:function(e){c.cacheLifecycles.__listener.didCache=e},didRecover:function(e){c.cacheLifecycles.__listener.didRecover=e}},c.componentWillReceiveProps=z?void 0:function(e){var t=Q(e,c.state);c.setState(t)},c.injectDOM=function(){try{R(c.__parentNode,"insertBefore",c.wrapper,c.__placeholderNode),R(c.__parentNode,"removeChild",c.__placeholderNode)}catch(e){}},c.ejectDOM=function(){try{var e=s(c.wrapper,"parentNode");c.__parentNode=e,R(c.__parentNode,"insertBefore",c.__placeholderNode,c.wrapper),R(c.__parentNode,"removeChild",c.wrapper)}catch(e){}},c.reset=function(){delete c.__revertScrollPos,c.setState({cached:!1})},c.refresh=function(){delete c.__revertScrollPos,c.setState({key:Math.random()})},c.__cacheCreateTime=Date.now(),c.__cacheUpdateTime=c.__cacheCreateTime,e.cacheKey){var a=R(e.cacheKey,void 0,e);if(e.multiple){var i=e.pathname;q(a,S({},D()[a],p({},i,c)))}else q(a,c)}if("undefined"!=typeof document){var u=R(e.cacheKey,void 0,e);c.__placeholderNode=document.createComment(" Route cached "+(u?'with cacheKey: "'+u+'" ':""))}return c.state=Q(e,{cached:!1,matched:!1,key:Math.random()}),c}return m(l,e),d(l,[{key:"componentDidUpdate",value:function(e,t){if(t.cached&&this.state.cached)return!0===t.matched&&!1===this.state.matched?(this.props.unmount&&this.ejectDOM(),this.__cacheUpdateTime=Date.now(),g(this.cacheLifecycles.__didCacheListener).forEach(function(e){R(e)}),R(this,"cacheLifecycles.__listener.didCache")):!1===t.matched&&!0===this.state.matched?(this.props.saveScrollPosition&&R(this.__revertScrollPos),this.__cacheUpdateTime=Date.now(),g(this.cacheLifecycles.__didRecoverListener).forEach(function(e){R(e)}),R(this,"cacheLifecycles.__listener.didRecover")):void 0}},{key:"shouldComponentUpdate",value:function(e,t){var n=!1===this.state.matched&&!0===t.matched,r=!0===this.state.cached&&!1===t.cached,o=this.state.matched||t.matched||this.state.cached!==t.cached;return o&&((this.props.unmount&&r||n)&&this.injectDOM(),r||n||!this.props.saveScrollPosition||(this.__revertScrollPos=A(this.props.unmount?this.wrapper:void 0))),o}},{key:"componentWillUnmount",value:function(){var e=this.props,t=e.unmount,n=e.pathname,r=e.multiple,o=R(this.props,"cacheKey",this.props);if(r){var c=S({},D()[o]);delete c[n],0===Object.keys(c).length?K(o):q(o,c)}else K(o);t&&this.injectDOM()}},{key:"render",value:function(){var t=this,e=this.state,n=e.matched,r=e.cached,o=e.key,c=this.props,a=c.className,i=void 0===a?"":a,u=c.behavior,l=c.children,h=y(R(u,void 0,!n),{}),s=h.className,f=void 0===s?"":s,d=T(h,["className"]),p=R(i+" "+f,"trim"),m=""!==p;return r?P.createElement("div",S({key:o,className:m?p:void 0},d,{ref:function(e){t.wrapper=e}}),P.createElement(W,{value:this.cacheLifecycles},R(l,void 0,this.cacheLifecycles))):null}}]),l}(j.Component);Y.__name="CacheComponent",Y.propsTypes={history:n.object.isRequired,match:n.object.isRequired,children:n.func.isRequired,className:n.string,when:n.oneOfType([n.func,n.oneOf(["forward","back","always"])]),behavior:n.func,unmount:n.bool,saveScrollPosition:n.bool},Y.defaultProps={when:"forward",unmount:!1,saveScrollPosition:!1,behavior:function(e){return e?{style:{display:"none"}}:void 0}},Y.getDerivedStateFromProps=z?Q:void 0;var Z=function(e){function a(){var e,t,n;f(this,a);for(var r=arguments.length,o=Array(r),c=0;c<r;c++)o[c]=arguments[c];return(t=n=v(this,(e=a.__proto__||Object.getPrototypeOf(a)).call.apply(e,[this].concat(o)))).render=function(){return R(n.props,"children")},n.shouldComponentUpdate=function(e){return e.when},v(n,t)}return m(a,e),a}(j.Component);Z.propsTypes={when:n.bool.isRequired};var $=r(j.Fragment),ee=function(e){function a(){var e,t,n;f(this,a);for(var r=arguments.length,o=Array(r),c=0;c<r;c++)o[c]=arguments[c];return(t=n=v(this,(e=a.__proto__||Object.getPrototypeOf(a)).call.apply(e,[this].concat(o)))).cache={},v(n,t)}return m(a,e),d(a,[{key:"render",value:function(){var e,d=this,t=this.props,p=t.children,m=t.render,y=t.component,v=t.className,_=t.when,b=t.behavior,w=t.cacheKey,g=t.unmount,C=t.saveScrollPosition,n=t.computedMatchForCacheRoute,O=t.multiple,r=T(t,["children","render","component","className","when","behavior","cacheKey","unmount","saveScrollPosition","computedMatchForCacheRoute","multiple"]);return(P.isValidElement(p)||(e=p,0!==P.Children.count(e)))&&(m=function(){return p}),n&&(r.computedMatch=n),O&&!$&&(O=!1),E(O)&&(O=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE;return e<t?t:n<e?n:e}(O,1)),P.createElement(u.Route,r,function(i){var u=i.match,l=i.computedMatch,e=i.location,t=J(i.match),n=e.pathname,r=e.search,o=e.state,c=E(O)?O:1/0,h={when:_,className:v,behavior:b,cacheKey:w,unmount:g,saveScrollPosition:C},a=function(t){return P.createElement(Y,t,function(e){return P.createElement(Z,{when:J(t.match)},function(){return Object.assign(t,{cacheLifecycles:e}),y?P.createElement(y,t):R(m||p,void 0,t)})})},s=o&&o.cacheBust?o.cacheBust:"",f=n+r;return s&&(f+=s),O&&t&&(d.cache[f]={updateTime:Date.now(),pathname:n,search:r,render:a},Object.entries(d.cache).sort(function(e,t){var n=L(e,2)[1];return L(t,2)[1].updateTime-n.updateTime}).forEach(function(e,t){var n=L(e,1)[0];c<=t&&delete d.cache[n]})),O?P.createElement(j.Fragment,null,Object.entries(d.cache).map(function(e){var t=L(e,2),n=t[0],r=t[1],o=r.render,c=r.pathname,a=n===f?u||l:null;return P.createElement(j.Fragment,{key:n},o(S({},i,h,{pathname:c,cacheKey:w,multiple:!0,key:c,match:a})))})):a(S({},i,h,{pathname:n,multiple:!1}))})}}]),a}(j.Component);ee.__name="CacheRoute",ee.propTypes={component:n.elementType||n.any,render:n.func,children:n.oneOfType([n.func,n.node]),computedMatchForCacheRoute:n.object,multiple:n.oneOfType([n.bool,n.number])},ee.defaultProps={multiple:!1};var te=r(j.Fragment)?function(e){var t=e.children;return P.createElement(j.Fragment,null,t)}:r(j.PropTypes)?function(e){var t=e.children;return P.createElement("div",null,t)}:function(e){return e.children};te.displayName="SwitchFragment";var ne=r(u.__RouterContext)||r(u.useHistory),re=function(e){function a(){var e,t,n;f(this,a);for(var r=arguments.length,o=Array(r),c=0;c<r;c++)o[c]=arguments[c];return(t=n=v(this,(e=a.__proto__||Object.getPrototypeOf(a)).call.apply(e,[this].concat(o)))).getContext=function(){if(ne){var e=n.props;return{location:e.location,match:e.match}}var t=n.context.router.route;return{location:n.props.location||t.location,match:t.match}},v(n,t)}return m(a,e),d(a,[{key:"render",value:function(){var e=this.props,t=e.children,o=e.which,n=this.getContext(),c=n.location,a=n.match,i=!1;return P.createElement(Z,{when:J(a)},function(){return P.createElement(te,null,P.Children.map(t,function(e){if(!P.isValidElement(e))return null;var t=e.props.path||e.props.from,n=i?null:t?u.matchPath(c.pathname,S({},e.props,{path:t}),a):a,r=void 0;return r=o(e)?P.cloneElement(e,S({location:c,computedMatch:n},l(n)?{computedMatchForCacheRoute:p({},G,!0)}:null)):n&&!i?P.cloneElement(e,{location:c,computedMatch:n}):null,i||(i=!!n),r}))})}}]),a}(u.Switch);ne?(re.propTypes={children:n.node,location:n.object.isRequired,match:n.object.isRequired,which:n.func},re=u.withRouter(re)):(re.contextTypes={router:n.shape({route:n.object.isRequired}).isRequired},re.propTypes={children:n.node,location:n.object,which:n.func}),re.defaultProps={which:function(e){return"CacheRoute"===s(e,"type.__name")}};var oe=re;e.default=ee,e.CacheRoute=ee,e.CacheSwitch=oe,e.dropByCacheKey=U,e.refreshByCacheKey=function(e){var t=s(k,[e]);t&&(t instanceof Y?B(t):Object.values(t).forEach(B))},e.getCachingKeys=function(){return x().map(function(e){return L(e,1)[0]})},e.clearCache=function(){x().forEach(function(e){var t=L(e,1)[0];return U(t)})},e.getCachingComponents=function(){return x().reduce(function(e,t){var n=L(t,2),c=n[0],r=n[1];return S({},e,r instanceof Y?p({},c,r):Object.entries(r).reduce(function(e,t){var n=L(t,2),r=n[0],o=n[1];return S({},e,p({},c+"."+r,o))},{}))},{})},e.useDidCache=I,e.useDidRecover=X,Object.defineProperty(e,"__esModule",{value:!0})});
